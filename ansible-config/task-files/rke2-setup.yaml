# RKE2 prerequisites
- name: Add first server IP to hosts
  lineinfile:
    path: /etc/hosts
    state: present
    line: "{{ rke2_initial_server_ip }}    {{ rke2_initial_server_hostname }}"
  when:
    - setup_hosts_file | default(true) | bool
    - not (initial_server | default(false) | bool)

- name: Gather service facts
  service_facts:

- name: Setup network manager
  blockinfile:
    path: /etc/NetworkManager/conf.d/rke2-canal.conf
    create: yes
    state: present
    block: |
      [keyfile]
      unmanaged-devices=interface-name:cali*;interface-name:flannel*
  when:
    - ansible_facts.services['NetworkManager.service'] is defined
    - ansible_facts.services['NetworkManager.service']['status'] != 'not-found'

- name: Reload Network manager
  systemd:
    service: NetworkManager
    state: reloaded
  when:
    - ansible_facts.services['NetworkManager.service'] is defined
    - ansible_facts.services['NetworkManager.service']['status'] != 'not-found'

- name: Stop FireWall
  systemd:
    service: firewalld
    enabled: false
    state: stopped
  when:
    - ansible_facts.services['firewalld.service'] is defined
    - ansible_facts.services['firewalld.service']['status'] != 'not-found'

# RKE2 server setup
- name: Create directory for custom Rancher root
  file:
    state: directory
    path: "{{ rke2_custom_root }}"
  when:
    - rke2_custom_root is defined

- name: Create symbolic link for Rancher root
  file:
    state: link
    src: "{{ rke2_custom_root }}"
    dest: /var/lib/rancher
    force: true
  when:
    - rke2_custom_root is defined

- name: Download RKE2 canal archive
  delegate_to: localhost
  run_once: yes
  get_url:
    url: https://github.com/rancher/rke2/releases/download/{{ rke2_version }}/rke2-images-canal.linux-amd64.tar.gz
    dest: rke2/rke2-images-canal.linux-amd64.tar.gz
  environment: "{{ proxy_env | default({}) }}"
  when:
    - rke2_air_gap_installation | default(true) | bool
    - "'rke2/rke2-images-canal.linux-amd64.tar.gz' is not file"
    - (rke2_cni | default('canal')) == 'canal'

- name: Download RKE2 calico archive
  delegate_to: localhost
  run_once: yes
  get_url:
    url: https://github.com/rancher/rke2/releases/download/{{ rke2_version }}/rke2-images-calico.linux-amd64.tar.gz
    dest: rke2/rke2-images-calico.linux-amd64.tar.gz
  environment: "{{ proxy_env | default({}) }}"
  when:
    - rke2_air_gap_installation | default(true) | bool
    - "'rke2/rke2-images-calico.linux-amd64.tar.gz' is not file"
    - (rke2_cni | default('canal')) == 'calico'

- name: Download RKE2 core archive
  delegate_to: localhost
  run_once: yes
  get_url:
    url: https://github.com/rancher/rke2/releases/download/{{ rke2_version }}/rke2-images-core.linux-amd64.tar.gz
    dest: rke2/rke2-images-core.linux-amd64.tar.gz
  environment: "{{ proxy_env | default({}) }}"
  when:
    - rke2_air_gap_installation | default(true) | bool
    - "'rke2/rke2-images-core.linux-amd64.tar.gz' is not file"

- name: Create directory for RKE2 images
  file:
    state: directory
    path: /var/lib/rancher/rke2/agent/images/
  when:
    - rke2_air_gap_installation | default(true) | bool

- name: Copy RKE2 canal archive to targets
  copy:
    src: rke2/rke2-images-canal.linux-amd64.tar.gz
    dest: /var/lib/rancher/rke2/agent/images/rke2-images-canal.linux-amd64.tar.gz
  when:
    - rke2_air_gap_installation | default(true) | bool
    - (rke2_cni | default('canal')) == 'canal'

- name: Copy RKE2 calico archive to targets
  copy:
    src: rke2/rke2-images-calico.linux-amd64.tar.gz
    dest: /var/lib/rancher/rke2/agent/images/rke2-images-calico.linux-amd64.tar.gz
  when:
    - rke2_air_gap_installation | default(true) | bool
    - (rke2_cni | default('canal')) == 'calico'

- name: Copy RKE2 core archive to targets
  copy:
    src: rke2/rke2-images-core.linux-amd64.tar.gz
    dest: /var/lib/rancher/rke2/agent/images/rke2-images-core.linux-amd64.tar.gz
  when:
    - rke2_air_gap_installation | default(true) | bool

- name: Upload RKE2 installer
  copy:
    src: rke2/rke2-install.sh
    dest: /tmp/rke2-install.sh
    mode: 0777

- name: Run installer
  shell: |
     export INSTALL_RKE2_VERSION="{{ rke2_version }}"
     /tmp/rke2-install.sh
  environment: "{{ proxy_env | default({}) }}"

- name: Create config file for first server
  blockinfile:
    path: /etc/rancher/rke2/config.yaml
    create: yes
    state: present
    block: |
      token: {{ rke2_shared_token }}
      cni: {{ rke2_cni | default('canal') }}
  when: initial_server | default(false) | bool

- name: Create config file for other servers
  blockinfile:
    path: /etc/rancher/rke2/config.yaml
    create: yes
    state: present
    block: |
      server: https://{{ rke2_initial_server_hostname }}:9345
      token: {{ rke2_shared_token }}
      cni: {{ rke2_cni | default('canal') }}
  when: not (initial_server | default(false) | bool)

- name: Create RKE2 daemon env file with proxy settings
  blockinfile:
    path: /etc/default/rke2-server
    create: yes
    state: present
    block: |
      {% for key, value in proxy_env.items() %}
      {% if key != 'no_proxy' %}
      CONTAINERD_{{ key | upper }}={{ value }}
      {% else %}
      CONTAINERD_{{ key | upper }}=127.0.0.0/8,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,.svc,.cluster.local,{{ value }}
      {% endif %}
      {% endfor %}
  when:
    - proxy_env is defined
    - rke2_add_containerd_proxy | default('no') | bool

- name: Enable RKE2 server
  systemd:
    service: rke2-server.service
    enabled: yes

- name: Start RKE2 initial server
  systemd:
    service: rke2-server.service
    state: started
  # It is required to run initial server before others
  when: initial_server | default(false) | bool

- name: Pause before launching of additional RKE2 servers
  pause:
    seconds: 10

- name: Start RKE2 additional servers
  throttle: 1
  systemd:
    service: rke2-server.service
    state: started
  when: not (initial_server | default(false) | bool)

- name: Link kubectl binary
  file:
    src: /var/lib/rancher/rke2/bin/kubectl
    dest: /bin/kubectl
    state: link

- name: Check status of the cluster nodes
  command: kubectl get nodes
  register: nodes_status
  environment:
    KUBECONFIG: "/etc/rancher/rke2/rke2.yaml"
  run_once: true

- name: View k8s nodes
  debug:
    msg: "{{ nodes_status.stdout }}"
  run_once: true

- name: Copy custom NGINX controller config
  copy:
    src: rke2/nginx-helm-chart-config.yaml
    dest: /var/lib/rancher/rke2/server/manifests/rke2-ingress-nginx-config.yaml
