# Repo-based installation
- name: Add bitnami repository
  kubernetes.core.helm_repository:
    repo_name: bitnami
    repo_url: https://charts.bitnami.com/bitnami
  environment: "{{ proxy_env | default({}) }}"

# MinIO installation
- name: Selecting initial server from inventory
  set_fact:
    initial_server: "{{ hostvars.values() | selectattr('initial_server', 'defined') }}"

- name: Copy custom MinIO file
  copy:
    src: minio/values.yaml
    dest: minio-values.yaml
  when:
    - inventory_hostname == initial_server[0].inventory_hostname

- name: Install MinIO release
  kubernetes.core.helm:
    release_name: minio
    chart_ref: bitnami/minio
    chart_version: "{{ minio_version }}"
    state: present
    values_files:
      - minio-values.yaml
    namespace: "{{ waldur_helm_namespace | default('default') }}"
    kubeconfig: /etc/rancher/rke2/rke2.yaml
  environment: "{{ proxy_env | default({}) }}"
  when:
    - inventory_hostname == initial_server[0].inventory_hostname
    - not (helm_commands_using_shell | default('false') | bool)

- name: Install MinIO release via shell
  shell: |
    export KUBECONFIG=/etc/rancher/rke2/rke2.yaml
    kubectl create namespace "{{ waldur_helm_namespace | default('default') }}" || true
    helm upgrade --install minio bitnami/minio --version "{{ minio_version }}" -n "{{ waldur_helm_namespace | default('default') }}" -f minio-values.yaml
  environment: "{{ proxy_env | default({}) }}"
  when:
    - inventory_hostname == initial_server[0].inventory_hostname
    - helm_commands_using_shell | default('false') | bool
